import type { Express } from "express";
import { createServer, type Server } from "http";
import { storage } from "./storage";
import { insertSymptomEntrySchema } from "@shared/schema";
import { z } from "zod";
import { generateChatResponse, generateClinicalReport, type PatientContext } from "./ai-service";

const DOCTOR_PASSWORD = "doctor123";

export async function registerRoutes(app: Express): Promise<Server> {
  
  // Submit symptom entry
  app.post("/api/symptoms", async (req, res) => {
    try {
      const validatedData = insertSymptomEntrySchema.parse(req.body);
      const entry = await storage.createSymptomEntry(validatedData);
      res.json(entry);
    } catch (error) {
      if (error instanceof z.ZodError) {
        res.status(400).json({ error: "Invalid input", details: error.errors });
      } else {
        res.status(500).json({ error: "Failed to create symptom entry" });
      }
    }
  });

  // Get user's symptom history
  app.get("/api/symptoms/user/:userId", async (req, res) => {
    try {
      const { userId } = req.params;
      const entries = await storage.getSymptomEntriesByUser(userId);
      res.json(entries);
    } catch (error) {
      res.status(500).json({ error: "Failed to fetch symptom entries" });
    }
  });

  // Doctor authentication
  app.post("/api/doctor/login", async (req, res) => {
    try {
      const { password } = req.body;
      if (password === DOCTOR_PASSWORD) {
        res.json({ success: true });
      } else {
        res.status(401).json({ error: "Invalid password" });
      }
    } catch (error) {
      res.status(500).json({ error: "Login failed" });
    }
  });

  // Get all symptom entries for doctor dashboard
  app.get("/api/doctor/symptoms", async (req, res) => {
    try {
      const { level } = req.query;
      let entries;
      
      if (level && level !== "all") {
        entries = await storage.getSymptomEntriesByTriageLevel(level as string);
      } else {
        entries = await storage.getAllSymptomEntries();
      }
      
      res.json(entries);
    } catch (error) {
      res.status(500).json({ error: "Failed to fetch symptom entries" });
    }
  });

  // Get dashboard statistics
  app.get("/api/doctor/stats", async (req, res) => {
    try {
      const allEntries = await storage.getAllSymptomEntries();
      const stats = {
        totalPatients: new Set(allEntries.map(e => e.userId)).size,
        urgentCases: allEntries.filter(e => e.triageLevel === 'urgent').length,
        monitorCases: allEntries.filter(e => e.triageLevel === 'monitor').length,
        safeCases: allEntries.filter(e => e.triageLevel === 'safe').length,
      };
      res.json(stats);
    } catch (error) {
      res.status(500).json({ error: "Failed to fetch statistics" });
    }
  });

  // AI Chat API Routes
  const chatMessageSchema = z.object({
    message: z.string().min(1),
    uid: z.string(),
    language: z.string(),
    patientName: z.string(),
    profileData: z.object({
      age: z.number().nullable().optional(),
      gender: z.string().nullable().optional(),
      medicalConditions: z.array(z.string()).optional(),
      allergies: z.array(z.string()).optional(),
      medications: z.array(z.string()).optional()
    }).optional(),
    recentSymptoms: z.array(z.object({
      symptoms: z.string(),
      triageLevel: z.string(),
      timestamp: z.string()
    })).optional()
  });

  app.post("/api/chat", async (req, res) => {
    try {
      const { message, uid, language, patientName, profileData, recentSymptoms } = chatMessageSchema.parse(req.body);
      
      // Use actual profile data from request with proper null handling
      const patientProfile = profileData ? {
        name: patientName,
        age: profileData.age || null,
        gender: profileData.gender || null,
        medicalConditions: profileData.medicalConditions || [],
        allergies: profileData.allergies || [],
        medications: profileData.medications || []
      } : {
        name: patientName,
        age: null,
        gender: null,
        medicalConditions: [],
        allergies: [],
        medications: []
      };
      
      // Create context with real Firebase symptom data
      const context: PatientContext = {
        uid,
        name: patientName,
        recentSymptoms: (recentSymptoms || []).map(symptom => ({
          symptoms: symptom.symptoms,
          triageLevel: symptom.triageLevel,
          timestamp: new Date(symptom.timestamp)
        })),
        language
      };

      // Get chat history for context (empty array for now since we're using Firebase on frontend)
      const emptyChatHistory: any[] = [];
      
      // Generate AI-powered response using open-source model with full patient data
      const enhancedContext = {
        ...context,
        profile: patientProfile
      };
      
      const response = await generateChatResponse(message, enhancedContext, emptyChatHistory);
      
      // Add simple disclaimer for health questions only
      const lowerMessage = message.toLowerCase();
      const isHealthQuestion = lowerMessage.includes('pain') || lowerMessage.includes('medication') || 
                              lowerMessage.includes('treatment') || lowerMessage.includes('symptom') ||
                              lowerMessage.includes('sick') || lowerMessage.includes('hurt') ||
                              lowerMessage.includes('doctor') || lowerMessage.includes('medicine');
      
      const finalResponse = isHealthQuestion ? 
        `${response}\n\nüí° This is AI-generated guidance and not a substitute for professional medical diagnosis.` : 
        response;
      
      res.json({ response: finalResponse });
    } catch (error) {
      console.error('Chat API error:', error);
      
      // Provide fallback response with proper medical disclaimer
      const fallbackResponses = {
        en: `I understand your health concerns. Please consider consulting with a healthcare professional for proper evaluation and guidance.

‚ö†Ô∏è This is AI-generated advice and is not a substitute for medical diagnosis.`,
        fr: `Je comprends vos pr√©occupations de sant√©. Veuillez consulter un professionnel de la sant√© pour une √©valuation et des conseils appropri√©s.

‚ö†Ô∏è Ceci est un conseil g√©n√©r√© par IA et ne remplace pas un diagnostic m√©dical.`,
        ar: `ÿ£ŸÅŸáŸÖ ŸÖÿÆÿßŸàŸÅŸÉ ÿßŸÑÿµÿ≠Ÿäÿ©. Ÿäÿ±ÿ¨Ÿâ ÿßÿ≥ÿ™ÿ¥ÿßÿ±ÿ© ÿ£ÿÆÿµÿßÿ¶Ÿä ÿßŸÑÿ±ÿπÿßŸäÿ© ÿßŸÑÿµÿ≠Ÿäÿ© ŸÑŸÑÿ≠ÿµŸàŸÑ ÿπŸÑŸâ ÿ™ŸÇŸäŸäŸÖ Ÿàÿ•ÿ±ÿ¥ÿßÿØÿßÿ™ ŸÖŸÜÿßÿ≥ÿ®ÿ©.

‚ö†Ô∏è Ÿáÿ∞Ÿá ŸÜÿµŸäÿ≠ÿ© ŸÖŸàŸÑÿØÿ© ÿ®ÿßŸÑÿ∞ŸÉÿßÿ° ÿßŸÑÿßÿµÿ∑ŸÜÿßÿπŸä ŸàŸÑŸäÿ≥ÿ™ ÿ®ÿØŸäŸÑÿßŸã ÿπŸÜ ÿßŸÑÿ™ÿ¥ÿÆŸäÿµ ÿßŸÑÿ∑ÿ®Ÿä.`
      };

      const fallback = fallbackResponses[req.body.language as keyof typeof fallbackResponses] || fallbackResponses.en;
      res.json({ response: fallback });
    }
  });

  // Clinical Report Generation - Enhanced with Firebase data
  app.post("/api/doctor/generate-report/:patientId", async (req, res) => {
    try {
      const { patientId } = req.params;
      const { patientName, patientEmail, patientData } = req.body;
      
      // Generate AI-powered clinical report
      const report = await generateClinicalReport(patientData);
      
      res.json(report);
    } catch (error) {
      console.error('Report generation error:', error);
      res.status(500).json({ error: "Failed to generate clinical report" });
    }
  });

  const httpServer = createServer(app);
  return httpServer;
}

// Enhanced local response generation with profile personalization
function generateLocalChatResponse(message: string, context: PatientContext, language: string, patientProfile?: any): string {
  const disclaimers = {
    en: "‚ö†Ô∏è This is AI-generated advice and is not a substitute for medical diagnosis.",
    fr: "‚ö†Ô∏è Ceci est un conseil g√©n√©r√© par IA et ne remplace pas un diagnostic m√©dical.",
    ar: "‚ö†Ô∏è Ÿáÿ∞Ÿá ŸÜÿµŸäÿ≠ÿ© ŸÖŸàŸÑÿØÿ© ÿ®ÿßŸÑÿ∞ŸÉÿßÿ° ÿßŸÑÿßÿµÿ∑ŸÜÿßÿπŸä ŸàŸÑŸäÿ≥ÿ™ ÿ®ÿØŸäŸÑÿßŸã ÿπŸÜ ÿßŸÑÿ™ÿ¥ÿÆŸäÿµ ÿßŸÑÿ∑ÿ®Ÿä."
  };

  // Personalized greeting based on profile
  const personalizedGreeting = {
    en: `Hello ${context.name.split(' ')[0]}, I understand your health concerns.`,
    fr: `Bonjour ${context.name.split(' ')[0]}, je comprends vos pr√©occupations de sant√©.`,
    ar: `ŸÖÿ±ÿ≠ÿ®ÿßŸã ${context.name.split(' ')[0]}ÿå ÿ£ŸÅŸáŸÖ ŸÖÿÆÿßŸàŸÅŸÉ ÿßŸÑÿµÿ≠Ÿäÿ©.`
  };

  // Enhanced responses with profile awareness
  const responses = {
    en: {
      greeting: personalizedGreeting.en,
      symptoms_reference: context.recentSymptoms.length > 0 
        ? `Looking at your symptom history: ${context.recentSymptoms.map(s => `"${s.symptoms}" (${s.triageLevel} level, ${s.timestamp.toLocaleDateString()})`).join(', ')}.` 
        : "",
      profile_context: patientProfile ? generateProfileContext(patientProfile, 'en') : "",
      general_advice: "I recommend monitoring your symptoms closely and consulting with a healthcare professional for proper evaluation.",
      emergency: "If you experience severe symptoms like difficulty breathing, chest pain, or loss of consciousness, seek immediate medical attention.",
      specific_advice: generateSpecificAdvice(message, context, patientProfile, 'en')
    },
    fr: {
      greeting: personalizedGreeting.fr,
      symptoms_reference: context.recentSymptoms.length > 0 
        ? `En examinant votre historique de sympt√¥mes: ${context.recentSymptoms.map(s => `"${s.symptoms}" (niveau ${s.triageLevel}, ${s.timestamp.toLocaleDateString()})`).join(', ')}.` 
        : "",
      profile_context: patientProfile ? generateProfileContext(patientProfile, 'fr') : "",
      general_advice: "Je recommande de surveiller attentivement vos sympt√¥mes et de consulter un professionnel de la sant√© pour une √©valuation appropri√©e.",
      emergency: "Si vous ressentez des sympt√¥mes graves comme une difficult√© √† respirer, des douleurs thoraciques ou une perte de conscience, consultez imm√©diatement un m√©decin.",
      specific_advice: generateSpecificAdvice(message, context, patientProfile, 'fr')
    },
    ar: {
      greeting: personalizedGreeting.ar,
      symptoms_reference: context.recentSymptoms.length > 0 
        ? `ÿ®ÿßŸÑŸÜÿ∏ÿ± ÿ•ŸÑŸâ ÿ™ÿßÿ±ŸäÿÆ ÿ£ÿπÿ±ÿßÿ∂ŸÉ: ${context.recentSymptoms.map(s => `"${s.symptoms}" (ŸÖÿ≥ÿ™ŸàŸâ ${s.triageLevel}ÿå ${s.timestamp.toLocaleDateString()})`).join('ÿå ')}.` 
        : "",
      profile_context: patientProfile ? generateProfileContext(patientProfile, 'ar') : "",
      general_advice: "ÿ£ŸÜÿµÿ≠ ÿ®ŸÖÿ±ÿßŸÇÿ®ÿ© ÿ£ÿπÿ±ÿßÿ∂ŸÉ ÿπŸÜ ŸÉÿ´ÿ® Ÿàÿßÿ≥ÿ™ÿ¥ÿßÿ±ÿ© ÿ£ÿÆÿµÿßÿ¶Ÿä ÿßŸÑÿ±ÿπÿßŸäÿ© ÿßŸÑÿµÿ≠Ÿäÿ© ŸÑŸÑÿ≠ÿµŸàŸÑ ÿπŸÑŸâ ÿ™ŸÇŸäŸäŸÖ ŸÖŸÜÿßÿ≥ÿ®.",
      emergency: "ÿ•ÿ∞ÿß ŸÉŸÜÿ™ ÿ™ÿπÿßŸÜŸä ŸÖŸÜ ÿ£ÿπÿ±ÿßÿ∂ ÿ¥ÿØŸäÿØÿ© ŸÖÿ´ŸÑ ÿµÿπŸàÿ®ÿ© ŸÅŸä ÿßŸÑÿ™ŸÜŸÅÿ≥ ÿ£Ÿà ÿ£ŸÑŸÖ ŸÅŸä ÿßŸÑÿµÿØÿ± ÿ£Ÿà ŸÅŸÇÿØÿßŸÜ ÿßŸÑŸàÿπŸäÿå ÿßÿ∑ŸÑÿ® ÿßŸÑÿπŸÜÿßŸäÿ© ÿßŸÑÿ∑ÿ®Ÿäÿ© ÿßŸÑŸÅŸàÿ±Ÿäÿ©.",
      specific_advice: generateSpecificAdvice(message, context, patientProfile, 'ar')
    }
  };

  const lang = language as keyof typeof responses;
  const langResponses = responses[lang] || responses.en;
  
  // Direct conversational response based on user's question
  const lowerMessage = message.toLowerCase();
  const userName = context.name.split(' ')[0];
  
  // Simple greetings
  if (lowerMessage.includes('hi') || lowerMessage.includes('hello') || lowerMessage.includes('hey')) {
    const greetings = {
      en: `Hi ${userName}! I'm ShifAI, your health assistant. How can I help you today?`,
      fr: `Salut ${userName}! Je suis ShifAI, votre assistant sant√©. Comment puis-je vous aider?`,
      ar: `ŸÖÿ±ÿ≠ÿ®ÿßŸã ${userName}! ÿ£ŸÜÿß ÿ¥ŸÅÿßÿ° ÿßŸÑÿ∞ŸÉŸäÿå ŸÖÿ≥ÿßÿπÿØŸÉ ÿßŸÑÿµÿ≠Ÿä. ŸÉŸäŸÅ ŸäŸÖŸÉŸÜŸÜŸä ŸÖÿ≥ÿßÿπÿØÿ™ŸÉÿü`
    };
    return greetings[lang] || greetings.en;
  }

  // Get specific advice using symptom context without listing everything
  const response = generateSpecificAdvice(message, context, patientProfile, language);
  
  // Add disclaimer only for health questions
  const isHealthQuestion = lowerMessage.includes('pain') || lowerMessage.includes('symptom') || 
                          lowerMessage.includes('hurt') || lowerMessage.includes('sick') ||
                          lowerMessage.includes('doctor') || lowerMessage.includes('worse');
  
  if (isHealthQuestion) {
    const shortDisclaimers = {
      en: "‚ö†Ô∏è AI guidance - consult a healthcare professional for diagnosis.",
      fr: "‚ö†Ô∏è Conseil IA - consultez un professionnel de sant√©.",
      ar: "‚ö†Ô∏è ÿ•ÿ±ÿ¥ÿßÿØÿßÿ™ ÿ∞ŸÉŸäÿ© - ÿßÿ≥ÿ™ÿ¥ÿ± ÿ£ÿÆÿµÿßÿ¶Ÿä ÿßŸÑÿ±ÿπÿßŸäÿ© ÿßŸÑÿµÿ≠Ÿäÿ©."
    };
    return `${response}\n\n${shortDisclaimers[lang] || shortDisclaimers.en}`;
  }
  
  return response;
}

// Generate profile-specific context
function generateProfileContext(profile: any, language: string): string {
  if (!profile) return "";
  
  const contextParts = [];
  
  if (profile.age) {
    const ageContext = {
      en: `Given your age of ${profile.age}, `,
      fr: `√âtant donn√© votre √¢ge de ${profile.age} ans, `,
      ar: `ŸÜÿ∏ÿ±ÿßŸã ŸÑÿπŸÖÿ±ŸÉ ${profile.age} ÿ≥ŸÜÿ©ÿå `
    };
    contextParts.push(ageContext[language as keyof typeof ageContext] || ageContext.en);
  }
  
  if (profile.medicalConditions && profile.medicalConditions.length > 0) {
    const conditionsContext = {
      en: `considering your medical history of ${profile.medicalConditions.join(', ')}, `,
      fr: `en tenant compte de vos ant√©c√©dents m√©dicaux de ${profile.medicalConditions.join(', ')}, `,
      ar: `ŸÖÿπ ÿßŸÑÿ£ÿÆÿ∞ ŸÅŸä ÿßŸÑÿßÿπÿ™ÿ®ÿßÿ± ÿ™ÿßÿ±ŸäÿÆŸÉ ÿßŸÑÿ∑ÿ®Ÿä ŸÖŸÜ ${profile.medicalConditions.join('ÿå ')}ÿå `
    };
    contextParts.push(conditionsContext[language as keyof typeof conditionsContext] || conditionsContext.en);
  }
  
  return contextParts.join('');
}

// Generate specific advice based on message content and context
function generateSpecificAdvice(message: string, context: PatientContext, profile: any, language: string): string {
  const lowerMessage = message.toLowerCase();
  const recentSymptoms = context.recentSymptoms;
  const hasRecentSymptoms = recentSymptoms.length > 0;
  
  // Analyze symptom context to provide intelligent responses
  const hasStomachIssues = hasRecentSymptoms && recentSymptoms.some(s => 
    s.symptoms.toLowerCase().includes('stomach') || s.symptoms.toLowerCase().includes('pain')
  );
  const hasHeadache = hasRecentSymptoms && recentSymptoms.some(s => 
    s.symptoms.toLowerCase().includes('headache') || s.symptoms.toLowerCase().includes('head')
  );
  const hasMonitorLevel = hasRecentSymptoms && recentSymptoms.some(s => s.triageLevel === 'monitor');
  const hasUrgentLevel = hasRecentSymptoms && recentSymptoms.some(s => s.triageLevel === 'urgent');

  // Worsening symptoms - context-aware response
  if (lowerMessage.includes('worsening') || lowerMessage.includes('worse') || lowerMessage.includes('getting worse')) {
    if (hasUrgentLevel || hasMonitorLevel) {
      return language === 'en' ? 
        `Worsening symptoms are concerning, especially given your recent health reports. I recommend seeking medical attention promptly. Don't wait if symptoms continue to deteriorate.` :
      language === 'fr' ?
        `L'aggravation des sympt√¥mes est pr√©occupante, surtout compte tenu de vos rapports de sant√© r√©cents. Je recommande de consulter rapidement un m√©decin.` :
        `ÿ™ŸÅÿßŸÇŸÖ ÿßŸÑÿ£ÿπÿ±ÿßÿ∂ ŸÖÿ´Ÿäÿ± ŸÑŸÑŸÇŸÑŸÇÿå ÿÆÿßÿµÿ© ŸÖÿπ ÿ™ŸÇÿßÿ±Ÿäÿ±ŸÉ ÿßŸÑÿµÿ≠Ÿäÿ© ÿßŸÑÿ£ÿÆŸäÿ±ÿ©. ÿ£ŸÜÿµÿ≠ ÿ®ÿ∑ŸÑÿ® ÿßŸÑÿπŸÜÿßŸäÿ© ÿßŸÑÿ∑ÿ®Ÿäÿ© ÿπŸÑŸâ ÿßŸÑŸÅŸàÿ±.`;
    }
    return language === 'en' ? 
      `If your symptoms are getting worse, it's important to monitor them closely and consider seeing a healthcare provider if the trend continues.` :
    language === 'fr' ?
      `Si vos sympt√¥mes s'aggravent, il est important de les surveiller attentivement et de consulter un professionnel de sant√© si la tendance continue.` :
      `ÿ•ÿ∞ÿß ŸÉÿßŸÜÿ™ ÿ£ÿπÿ±ÿßÿ∂ŸÉ ÿ™ÿ™ŸÅÿßŸÇŸÖÿå ŸÖŸÜ ÿßŸÑŸÖŸáŸÖ ŸÖÿ±ÿßŸÇÿ®ÿ™Ÿáÿß ÿπŸÜ ŸÉÿ´ÿ® ŸàÿßŸÑŸÜÿ∏ÿ± ŸÅŸä ÿ±ÿ§Ÿäÿ© ŸÖŸÇÿØŸÖ ÿßŸÑÿ±ÿπÿßŸäÿ© ÿßŸÑÿµÿ≠Ÿäÿ© ÿ•ÿ∞ÿß ÿßÿ≥ÿ™ŸÖÿ± Ÿáÿ∞ÿß ÿßŸÑÿßÿ™ÿ¨ÿßŸá.`;
  }
  
  // Doctor consultation questions
  if (lowerMessage.includes('should i see') || lowerMessage.includes('doctor') || lowerMessage.includes('hospital')) {
    if (hasUrgentLevel) {
      return language === 'en' ? 
        `Yes, based on your symptom severity, you should seek medical attention promptly.` :
      language === 'fr' ?
        `Oui, bas√© sur la gravit√© de vos sympt√¥mes, vous devriez consulter rapidement un m√©decin.` :
        `ŸÜÿπŸÖÿå ÿ®ŸÜÿßÿ°Ÿã ÿπŸÑŸâ ÿ¥ÿØÿ© ÿ£ÿπÿ±ÿßÿ∂ŸÉÿå Ÿäÿ¨ÿ® ÿ£ŸÜ ÿ™ÿ∑ŸÑÿ® ÿßŸÑÿπŸÜÿßŸäÿ© ÿßŸÑÿ∑ÿ®Ÿäÿ© ÿπŸÑŸâ ÿßŸÑŸÅŸàÿ±.`;
    } else if (hasMonitorLevel) {
      return language === 'en' ? 
        `Given your recent symptoms, scheduling an appointment with your doctor would be a good idea, especially if they persist.` :
      language === 'fr' ?
        `√âtant donn√© vos sympt√¥mes r√©cents, prendre rendez-vous avec votre m√©decin serait une bonne id√©e, surtout s'ils persistent.` :
        `ŸÜÿ∏ÿ±Ÿãÿß ŸÑÿ£ÿπÿ±ÿßÿ∂ŸÉ ÿßŸÑÿ£ÿÆŸäÿ±ÿ©ÿå ÿ≥ŸäŸÉŸàŸÜ ŸÖŸÜ ÿßŸÑÿ¨ŸäÿØ ÿ™ÿ≠ÿØŸäÿØ ŸÖŸàÿπÿØ ŸÖÿπ ÿ∑ÿ®Ÿäÿ®ŸÉÿå ÿÆÿßÿµÿ© ÿ•ÿ∞ÿß ÿßÿ≥ÿ™ŸÖÿ±ÿ™.`;
    }
    return language === 'en' ? 
      `Consider seeing a doctor if symptoms persist, worsen, or if you're concerned about your health.` :
    language === 'fr' ?
      `Consultez un m√©decin si les sympt√¥mes persistent, s'aggravent ou si vous √™tes pr√©occup√© par votre sant√©.` :
      `ŸÅŸÉÿ± ŸÅŸä ÿ±ÿ§Ÿäÿ© ÿ∑ÿ®Ÿäÿ® ÿ•ÿ∞ÿß ÿßÿ≥ÿ™ŸÖÿ±ÿ™ ÿßŸÑÿ£ÿπÿ±ÿßÿ∂ ÿ£Ÿà ÿ™ŸÅÿßŸÇŸÖÿ™ ÿ£Ÿà ÿ•ÿ∞ÿß ŸÉŸÜÿ™ ŸÇŸÑŸÇŸãÿß ÿ®ÿ¥ÿ£ŸÜ ÿµÿ≠ÿ™ŸÉ.`;
  }
  
  // Stomach pain questions
  if (lowerMessage.includes('stomach') && hasStomachIssues) {
    return language === 'en' ? 
      `For stomach discomfort, try eating bland foods, stay hydrated, and rest. If pain is severe or persistent, seek medical care.` :
    language === 'fr' ?
      `Pour l'inconfort gastrique, essayez de manger des aliments fades, restez hydrat√© et reposez-vous. Si la douleur est s√©v√®re ou persistante, consultez un m√©decin.` :
      `ŸÑÿπÿØŸÖ ÿßŸÑÿ±ÿßÿ≠ÿ© ŸÅŸä ÿßŸÑŸÖÿπÿØÿ©ÿå ÿ¨ÿ±ÿ® ÿ™ŸÜÿßŸàŸÑ ÿßŸÑÿ£ÿ∑ÿπŸÖÿ© ÿßŸÑÿÆŸÅŸäŸÅÿ©ÿå Ÿàÿßÿ¥ÿ±ÿ® ÿßŸÑŸÉÿ´Ÿäÿ± ŸÖŸÜ ÿßŸÑÿ≥Ÿàÿßÿ¶ŸÑÿå Ÿàÿßÿ≠ÿµŸÑ ÿπŸÑŸâ ÿßŸÑÿ±ÿßÿ≠ÿ©. ÿ•ÿ∞ÿß ŸÉÿßŸÜ ÿßŸÑÿ£ŸÑŸÖ ÿ¥ÿØŸäÿØŸãÿß ÿ£Ÿà ŸÖÿ≥ÿ™ŸÖÿ±Ÿãÿßÿå ÿßÿ∑ŸÑÿ® ÿßŸÑÿ±ÿπÿßŸäÿ© ÿßŸÑÿ∑ÿ®Ÿäÿ©.`;
  }
  
  // Headache questions
  if (lowerMessage.includes('headache') && hasHeadache) {
    return language === 'en' ? 
      `For headaches, ensure you're well-hydrated, get adequate rest, and try to manage stress. If headaches are frequent or severe, consult your doctor.` :
    language === 'fr' ?
      `Pour les maux de t√™te, assurez-vous d'√™tre bien hydrat√©, reposez-vous suffisamment et essayez de g√©rer le stress. Si les maux de t√™te sont fr√©quents ou s√©v√®res, consultez votre m√©decin.` :
      `ŸÑŸÑÿµÿØÿßÿπÿå ÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿ¥ÿ±ÿ® ÿßŸÑŸÉÿ´Ÿäÿ± ŸÖŸÜ ÿßŸÑÿ≥Ÿàÿßÿ¶ŸÑÿå Ÿàÿßÿ≠ÿµŸÑ ÿπŸÑŸâ ÿ±ÿßÿ≠ÿ© ŸÉÿßŸÅŸäÿ©ÿå Ÿàÿ≠ÿßŸàŸÑ ÿ•ÿØÿßÿ±ÿ© ÿßŸÑÿ∂ÿ∫ÿ∑. ÿ•ÿ∞ÿß ŸÉÿßŸÜ ÿßŸÑÿµÿØÿßÿπ ŸÖÿ™ŸÉÿ±ÿ±Ÿãÿß ÿ£Ÿà ÿ¥ÿØŸäÿØŸãÿßÿå ÿßÿ≥ÿ™ÿ¥ÿ± ÿ∑ÿ®Ÿäÿ®ŸÉ.`;
  }
  
  // General pain management
  if (lowerMessage.includes('pain') || lowerMessage.includes('hurt')) {
    return language === 'en' ? 
      `For pain management, rest and gentle movement can help. Stay hydrated and monitor pain levels. Seek medical attention if pain is severe or interfering with daily activities.` :
    language === 'fr' ?
      `Pour la gestion de la douleur, le repos et les mouvements doux peuvent aider. Restez hydrat√© et surveillez les niveaux de douleur. Consultez un m√©decin si la douleur est s√©v√®re.` :
      `ŸÑÿ•ÿØÿßÿ±ÿ© ÿßŸÑÿ£ŸÑŸÖÿå ŸäŸÖŸÉŸÜ ÿ£ŸÜ ÿ™ÿ≥ÿßÿπÿØ ÿßŸÑÿ±ÿßÿ≠ÿ© ŸàÿßŸÑÿ≠ÿ±ŸÉÿ© ÿßŸÑŸÑÿ∑ŸäŸÅÿ©. ÿßÿ¥ÿ±ÿ® ÿßŸÑŸÉÿ´Ÿäÿ± ŸÖŸÜ ÿßŸÑÿ≥Ÿàÿßÿ¶ŸÑ Ÿàÿ±ÿßŸÇÿ® ŸÖÿ≥ÿ™ŸàŸäÿßÿ™ ÿßŸÑÿ£ŸÑŸÖ. ÿßÿ∑ŸÑÿ® ÿßŸÑÿπŸÜÿßŸäÿ© ÿßŸÑÿ∑ÿ®Ÿäÿ© ÿ•ÿ∞ÿß ŸÉÿßŸÜ ÿßŸÑÿ£ŸÑŸÖ ÿ¥ÿØŸäÿØŸãÿß.`;
  }
  if (lowerMessage.includes('stress') || lowerMessage.includes('anxiety') || lowerMessage.includes('worried')) {
    const stressAdvice = {
      en: "Consider stress management techniques like deep breathing, meditation, or gentle exercise. If anxiety persists, professional support can be very helpful.",
      fr: "Consid√©rez des techniques de gestion du stress comme la respiration profonde, la m√©ditation ou l'exercice l√©ger. Si l'anxi√©t√© persiste, un soutien professionnel peut √™tre tr√®s utile.",
      ar: "ŸÅŸÉÿ± ŸÅŸä ÿ™ŸÇŸÜŸäÿßÿ™ ÿ•ÿØÿßÿ±ÿ© ÿßŸÑÿ•ÿ¨ŸáÿßÿØ ŸÖÿ´ŸÑ ÿßŸÑÿ™ŸÜŸÅÿ≥ ÿßŸÑÿπŸÖŸäŸÇ ŸàÿßŸÑÿ™ÿ£ŸÖŸÑ ÿ£Ÿà ÿßŸÑÿ™ŸÖÿßÿ±ŸäŸÜ ÿßŸÑŸÑÿ∑ŸäŸÅÿ©. ÿ•ÿ∞ÿß ÿßÿ≥ÿ™ŸÖÿ± ÿßŸÑŸÇŸÑŸÇÿå ŸäŸÖŸÉŸÜ ÿ£ŸÜ ŸäŸÉŸàŸÜ ÿßŸÑÿØÿπŸÖ ÿßŸÑŸÖŸáŸÜŸä ŸÖŸÅŸäÿØÿßŸã ÿ¨ÿØÿßŸã."
    };
    return stressAdvice[language as keyof typeof stressAdvice] || stressAdvice.en;
  }
  
  // Thank you responses
  if (lowerMessage.includes('thank') || lowerMessage.includes('thanks')) {
    return language === 'en' ? 
      `You're welcome! I'm here to help with your health questions anytime.` :
    language === 'fr' ?
      `De rien! Je suis l√† pour vous aider avec vos questions de sant√© √† tout moment.` :
      `ÿπŸÑŸâ ÿßŸÑÿ±ÿ≠ÿ® ŸàÿßŸÑÿ≥ÿπÿ©! ÿ£ŸÜÿß ŸáŸÜÿß ŸÑŸÖÿ≥ÿßÿπÿØÿ™ŸÉ ŸÅŸä ÿ£ÿ≥ÿ¶ŸÑÿ™ŸÉ ÿßŸÑÿµÿ≠Ÿäÿ© ŸÅŸä ÿ£Ÿä ŸàŸÇÿ™.`;
  }

  // General health questions
  if (lowerMessage.includes('how are you') || lowerMessage.includes('what can you do')) {
    return language === 'en' ? 
      `I'm ShifAI, your health assistant. I can help answer health questions, provide guidance based on your symptom history, and suggest when to seek medical care.` :
    language === 'fr' ?
      `Je suis ShifAI, votre assistant sant√©. Je peux aider √† r√©pondre aux questions de sant√©, fournir des conseils bas√©s sur votre historique de sympt√¥mes.` :
      `ÿ£ŸÜÿß ÿ¥ŸÅÿßÿ° ÿßŸÑÿ∞ŸÉŸäÿå ŸÖÿ≥ÿßÿπÿØŸÉ ÿßŸÑÿµÿ≠Ÿä. ŸäŸÖŸÉŸÜŸÜŸä ÿßŸÑŸÖÿ≥ÿßÿπÿØÿ© ŸÅŸä ÿßŸÑÿ•ÿ¨ÿßÿ®ÿ© ÿπŸÑŸâ ÿßŸÑÿ£ÿ≥ÿ¶ŸÑÿ© ÿßŸÑÿµÿ≠Ÿäÿ© Ÿàÿ™ŸÇÿØŸäŸÖ ÿßŸÑÿ™Ÿàÿ¨ŸäŸá ÿ®ŸÜÿßÿ°Ÿã ÿπŸÑŸâ ÿ™ÿßÿ±ŸäÿÆ ÿ£ÿπÿ±ÿßÿ∂ŸÉ.`;
  }
  
  // General fallback for health-related questions
  return language === 'en' ? 
    `I understand your concern. For specific health questions, it's always best to consult with a healthcare professional who can properly evaluate your situation.` :
  language === 'fr' ?
    `Je comprends votre pr√©occupation. Pour des questions de sant√© sp√©cifiques, il est toujours pr√©f√©rable de consulter un professionnel de la sant√©.` :
    `ÿ£ŸÅŸáŸÖ ŸÇŸÑŸÇŸÉ. ŸÑŸÑÿ£ÿ≥ÿ¶ŸÑÿ© ÿßŸÑÿµÿ≠Ÿäÿ© ÿßŸÑŸÖÿ≠ÿØÿØÿ©ÿå ŸÖŸÜ ÿßŸÑÿ£ŸÅÿ∂ŸÑ ÿØÿßÿ¶ŸÖŸãÿß ÿßÿ≥ÿ™ÿ¥ÿßÿ±ÿ© ÿ£ÿÆÿµÿßÿ¶Ÿä ÿßŸÑÿ±ÿπÿßŸäÿ© ÿßŸÑÿµÿ≠Ÿäÿ©.`;
}

function generateEnhancedClinicalReport(patientId: string, patientName: string, patientEmail: string, patientData: any) {
  const entries = patientData?.entries || [];
  const profile = patientData?.profile || {};
  
  const totalEntries = entries.length;
  const urgentEntries = entries.filter((e: any) => e.triageLevel === 'urgent').length;
  const monitorEntries = entries.filter((e: any) => e.triageLevel === 'monitor').length;
  const safeEntries = entries.filter((e: any) => e.triageLevel === 'safe').length;

  // Enhanced summary with real patient data
  const symptomsList = entries.slice(0, 5).map((e: any) => `"${e.symptoms}" (${e.triageLevel})`).join(', ');
  const ageContext = profile.age ? ` Age: ${profile.age}.` : '';
  const conditionsContext = profile.medicalConditions?.length > 0 ? ` Medical history: ${profile.medicalConditions.join(', ')}.` : '';
  
  // Timeline analysis
  const sortedEntries = entries.sort((a: any, b: any) => new Date(b.timestamp).getTime() - new Date(a.timestamp).getTime());
  const timelineEvents = sortedEntries.slice(0, 5).map((e: any) => 
    `${new Date(e.timestamp).toLocaleDateString()}: ${e.symptoms} (${e.triageLevel})`
  ).join('\n');

  // Risk assessment based on patterns
  let riskLevel = 'LOW';
  let riskDetails = 'Symptoms appear manageable with routine care.';
  
  if (urgentEntries > 0) {
    riskLevel = 'HIGH PRIORITY';
    riskDetails = `${urgentEntries} urgent-level symptoms detected. Immediate evaluation required.`;
  } else if (monitorEntries > 1) {
    riskLevel = 'MODERATE';
    riskDetails = `Multiple monitor-level symptoms (${monitorEntries}) suggest ongoing health concerns requiring professional assessment.`;
  } else if (monitorEntries === 1) {
    riskLevel = 'MODERATE';
    riskDetails = 'Single monitor-level symptom warrants medical consultation within 2-3 days.';
  }

  // Personalized recommendations
  let recommendations = 'Continue symptom monitoring and maintain regular healthcare check-ups.';
  if (urgentEntries > 0) {
    recommendations = 'IMMEDIATE ACTION: Urgent medical evaluation required. Consider emergency care if symptoms persist or worsen.';
  } else if (monitorEntries > 0) {
    recommendations = `Schedule medical appointment within 48-72 hours. Monitor for symptom progression.${profile.age && profile.age > 65 ? ' Given patient age, prioritize prompt evaluation.' : ''}`;
  }

  return {
    patientId,
    summary: `Patient ${patientName} (${patientEmail}) has submitted ${totalEntries} symptom entries.${ageContext}${conditionsContext} Recent symptoms include: ${symptomsList || 'No recent symptoms recorded'}.`,
    timeline: totalEntries > 0 ? `Recent symptom progression:\n${timelineEvents}` : 'No symptom timeline available.',
    riskAnalysis: `${riskLevel}: ${riskDetails} Distribution: ${urgentEntries} urgent, ${monitorEntries} monitor, ${safeEntries} safe.`,
    recommendations: recommendations,
    generatedAt: new Date()
  };
}
